<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            text-align: center;
        }
        nav {
            background-color: #595d61;
            padding: 10px;
        }
        nav ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: space-around;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
        }
        .main-content {
            display: flex;
            flex: 1;
        }
        .sidebar {
            width: 300px;
            background-color: #ecf0f1;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .content {
            flex: 1;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .status-bar {
            background-color: #a3a9a9;
            color: white;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .status-section {
            background-color: #6f7478;
            padding: 10px;
            border-radius: 5px;
        }
        .status-section h3 {
            margin-top: 0;
        }
        .task-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .task-list li {
            background-color: #727980;
            padding: 5px;
            margin-bottom: 5px;
            border-radius: 3px;
        }
        .group-section {
            margin-bottom: 20px;
        }
        .group-section h2 {
            margin-top: 0;
        }
        .courseware-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .bookmarks {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            height: 50px;
        }
        .courseware-content {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            flex: 1;
        }
        .add-task {
            display: flex;
            gap: 10px;
        }
        .add-task input {
            flex: 1;
            padding: 5px;
        }
        .add-task button {
            padding: 5px 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .add-task button:hover {
            background-color: #2980b9;
        }
        /* 新增的房间选择样式 */
        .room-form {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #d6dbdf;
            border-radius: 5px;
        }
        .room-form h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .room-form input[type="text"] {
            width: 100%;
            padding: 5px;
            margin-bottom: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .room-form button {
            width: 100%;
            padding: 5px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .room-form button:hover {
            background-color: #2980b9;
        }
        .messages {
            margin-bottom: 10px;
            font-size: 14px;
        }
        .messages .error {
            color: #e74c3c;
        }
        .messages .success {
            color: #27ae60;
        }
         .add-task-container {
            display: flex;
            gap: 10px;
            margin-top: 10px; /* 增加上边距 */
        }
         .add-task-container select,
        .add-task-container input[type="text"],
        .add-task-container button {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .add-task-container button {
            background-color: #3498db;
            color: white;
            cursor: pointer;
        }
        .add-task-container button:hover {
            background-color: #2980b9;
        }
        .pdf-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            overflow-y: auto;
            height: calc(100vh - 60px); /* 减去 header 的高度 */
        }

        .pdf-item {
            width: 200px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .pdf-item img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .pdf-item:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        .pdf-title {
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <header>
        <h1>Lesson Page</h1>
    </header>
    <nav>
        <ul>
            <li><a href="/login/IDE">Go Back</a></li>
            <li><a href="/login/IDE/lesson/self-learn">Self-Learn</a></li>
        </ul>
    </nav>
    <div class="main-content">
        <div class="sidebar">
            <div class="group-section">
                <h2>小组学习</h2>

                <!-- 房间选择功能 -->
                <div id="message" class="messages"></div>

                <div class="room-form">
{#                    <h4>创建房间</h4>#}
{#                    <form id="create-room-form" method="POST" action="{% url 'lesson:create_room' %}">#}
{#                        {% csrf_token %}#}
{#                        <input type="text" name="room_name" placeholder="输入房间名称" required>#}
{#                        <button type="submit">创建房间</button>#}
{#                    </form>#}
                    <h4>创建房间</h4>
                    <form id="create-room-form" method="POST" action="{% url 'lesson:create_room' %}">
                        {% csrf_token %}
                        <button type="submit">创建新房间</button>
                    </form>
                </div>

                <div class="room-form">
                    <h4>加入房间</h4>
                    <form id="join-room-form" method="POST" action="{% url 'lesson:join_room' %}">
                        {% csrf_token %}
                        <input type="text" name="room_name" placeholder="输入房间名称" required>
                        <button type="submit">加入房间</button>
                    </form>
                </div>

                <div class="room-form">
                    <h4>删除房间</h4>
                    <form id="delete-room-form" method="POST" action="">
                        {% csrf_token %}
                        <input type="text" name="room_name" placeholder="输入房间名称" required>
                        <button type="submit">删除房间</button>
                    </form>
                </div>
            </div>

        <div class="status-bar">
            <!-- 关注 -->
            <div class="status-section">
                <h3>关注focus</h3>
                <ul class="task-list" id="focus-list"></ul>
            </div>
            <!-- 即将 -->
            <div class="status-section">
                <h3>即将upcoming</h3>
                <ul class="task-list" id="upcoming-list"></ul>
            </div>
            <!-- 完成 -->
            <div class="status-section">
                <h3>完成completed</h3>
                <ul class="task-list" id="completed-list"></ul>
            </div>
        </div>
            
        </div>
        <div class="content">
            <div class="courseware-section">
                <div class="bookmarks">
                    <h3>书签</h3>
                </div>
                <div class="courseware-content">
                    <h3>课件内容</h3>
                    <div class="pdf-gallery" id="pdf-gallery">
                        <!-- PDF 展示区域 -->
                    </div>
                    <!-- 修改 PDF 上传按钮 -->
                    <div class="pdf-upload-btn" style="margin-top: 20px;">
                        <h4>上传PDF</h4>
                        <form id="pdf-upload-form" method="POST" enctype="multipart/form-data" action="/login/IDE/lesson/self-learn/upload_pdf/">
                            {% csrf_token %}
                            <input type="file" name="pdf" accept=".pdf" required>
                            <button type="submit">上传PDF</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
        <!-- 添加任务的输入框 -->
    <div class="add-task-container">
        <select id="task-section">
            <option value="focus-list">关注</option>
            <option value="upcoming-list">即将</option>
            <option value="completed-list">完成</option>
        </select>
        <input type="text" id="new-task-input" placeholder="添加任务">
        <button onclick="addTask()">添加</button>
    </div>

    <script>
        function addTask(section) {
            const input = document.getElementById(`${section}-input`);
            const taskText = input.value.trim();
            if (taskText) {
                const list = document.getElementById(`${section}-list`);
                const li = document.createElement('li');
                li.textContent = taskText;
                list.appendChild(li);
                input.value = '';
            }
        }

        // 处理创建房间表单提交
        {#document.getElementById('create-room-form').addEventListener('submit', function (e) {#}
        {#    e.preventDefault();#}
        {#    const formData = new FormData(this);#}
        {#    fetch("{% url 'lesson:create_room' %}", {#}
        {#        method: 'POST',#}
        {#        body: formData,#}
        {#        headers: {#}
        {#            'X-CSRFToken': formData.get('csrfmiddlewaretoken')#}
        {#        }#}
        {#    })#}
        {#    .then(response => {#}
        {#        if (response.status === 201) {#}
        {#            document.getElementById('message').innerHTML = `<div class="success">房间创建成功！</div>`;#}
        {#        } else {#}
        {#            document.getElementById('message').innerHTML = `<div class="error">房间已存在，请使用其他名称！</div>`;#}
        {#        }#}
        {#    })#}
        {#    .catch(error => {#}
        {#        console.error('Error:', error);#}
        {#    });#}
        {#);#}

        document.getElementById('create-room-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("{% url 'lesson:create_room' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('message').innerHTML =
                        `<div class="success">房间创建成功！房间号: ${data.room_id}</div>`;
                    // 自动跳转到新创建的房间
                    window.location.href = `/login/IDE/lesson/group-${data.room_id}`;
                } else {
                    document.getElementById('message').innerHTML =
                        `<div class="error">${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        // 处理加入房间表单提交
        document.getElementById('join-room-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("{% url 'lesson:join_room' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.href = `/login/IDE/lesson/group-${data.room_name}`;
                } else {
                    document.getElementById('message').innerHTML = `<div class="error">${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        // 处理删除房间表单提交
        document.getElementById('delete-room-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const roomName = formData.get('room_name');

            const deleteUrl = `/login/IDE/lesson/delete-room/group-${roomName}/`;

            fetch(deleteUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
                if (response.status === 200) {
                    document.getElementById('message').innerHTML = `<div class="success">房间删除成功！</div>`;
                } else {
                    document.getElementById('message').innerHTML = `<div class="error">你无法删除该房间！</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        async function loadPdfGallery() {
            const response = await fetch('/login/IDE/lesson/self-learn/get_pdf_list/');
            const data = await response.json();
            const pdfGallery = document.getElementById('pdf-gallery');

            data.pdfs.forEach(pdf => {
                const pdfName = pdf.split('.pdf')[0]; // 去掉扩展名
                const encodedPdfName = encodeURIComponent(pdfName); // 编码文件名
                const thumbnailUrl = `/media/pdf_images/${encodedPdfName}_page_1.jpg`; // 第一页缩略图路径

                // 创建 PDF 展示项
                const pdfItem = document.createElement('div');
                pdfItem.className = 'pdf-item';
                pdfItem.dataset.pdfName = pdf; // 存储 PDF 文件名

                pdfItem.innerHTML = `
                    <img src="${thumbnailUrl}" alt="${pdfName}" onerror="this.src='/static/images/default-thumbnail.jpg';">
                    <div class="pdf-title">${pdfName}</div>
                `;

                // 双击事件：跳转到 self-learn 界面
                pdfItem.ondblclick = () => {
                    const url = `/login/IDE/lesson/self-learn/pdf/viewer/?pdf_name=${encodeURIComponent(pdf)}`;
                    window.location.href = url;
                };

                pdfGallery.appendChild(pdfItem);
            });
        }

        // 加载 PDF 展示
        loadPdfGallery();
    </script>
<script>
    document.getElementById('pdf-upload-form').addEventListener('submit', async function (e) {
        e.preventDefault(); // 阻止默认表单提交行为

        const formData = new FormData(this);
        const response = await fetch('/login/IDE/lesson/self-learn/upload_pdf/', {
            method: 'POST',
            body: formData,
        });

        if (response.ok) {
            const data = await response.json();
            alert(data.message || 'PDF 上传成功！');
            location.reload(); // 上传成功后刷新页面
        } else {
            const errorData = await response.json();
            alert(errorData.error || 'PDF 上传失败！');
        }
    });
</script>
<script>
        // 添加任务
        function addTask() {
            const section = document.getElementById('task-section').value;
            const input = document.getElementById('new-task-input');
            const taskText = input.value.trim();
            if (taskText) {
                const list = document.getElementById(section);
                const li = createTaskItem(taskText);
                list.appendChild(li);
                input.value = '';
            }
        }

        // 创建任务项
        function createTaskItem(taskText) {
            const li = document.createElement('li');
            li.className = 'task-item'; // 添加样式类
            li.textContent = taskText;

            // 删除按钮
            const deleteButton = document.createElement('button');
            deleteButton.textContent = '删除';
            deleteButton.onclick = () => deleteTask(li);

            // 移动按钮
            const moveButton = document.createElement('button');
            moveButton.textContent = '移动';
            moveButton.onclick = () => showMoveOptions(li);

            // 将按钮添加到任务项中
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'task-actions';
            buttonContainer.appendChild(deleteButton);
            buttonContainer.appendChild(moveButton);

            li.appendChild(buttonContainer); // 将按钮容器添加到任务项中
            return li;
        }

        // 删除任务
        function deleteTask(taskItem) {
            const parentList = taskItem.parentElement;
            parentList.removeChild(taskItem);
        }

        // 显示移动选项
        function showMoveOptions(taskItem) {
            const currentList = taskItem.parentElement;
            const allLists = document.querySelectorAll('.task-list');

            // 创建一个临时菜单
            const menu = document.createElement('div');
            menu.className = 'move-menu';
            menu.style.position = 'absolute';
            menu.style.border = '1px solid #ccc';
            menu.style.backgroundColor = 'white';
            menu.style.padding = '5px';
            menu.style.zIndex = '1000';

            // 添加“移动到”选项
            allLists.forEach((list) => {
                if (list !== currentList) {
                    const option = document.createElement('div');
                    option.textContent = list.id.replace('-list', ''); // 获取状态名称
                    option.onclick = () => moveTask(taskItem, list,menu);
                    menu.appendChild(option);
                }
            });

            // 添加关闭选项
            const closeButton = document.createElement('div');
            closeButton.textContent = '关闭';
            closeButton.onclick = () => menu.remove();
            menu.appendChild(closeButton);

            // 将菜单添加到页面
            document.body.appendChild(menu);

            // 定位菜单
            const rect = taskItem.getBoundingClientRect();
            menu.style.left = `${rect.left}px`;
            menu.style.top = `${rect.bottom + 5}px`;
        }

        // 移动任务
        function moveTask(taskItem, targetList,menu) {
            targetList.appendChild(taskItem); // 将任务项移动到目标列表
            menu.remove();
        }
    </script>
    {% include 'embed.html' %}
</body>
</html>
