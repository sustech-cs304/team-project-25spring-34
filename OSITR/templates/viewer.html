<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>PDF é¢„è§ˆ - ä¹¦ç­¾å¯¼èˆª</title>
    <style>
        body { font-family: Arial, sans-serif; }
        #bookmarks { list-style: none; padding: 0; }
        #bookmarks li { cursor: pointer; padding: 5px; border-bottom: 1px solid #ddd; }
        #bookmarks li:hover { background-color: #f0f0f0; }
    </style>
</head>
<body>

    <h1>PDF é¢„è§ˆ - ä¹¦ç­¾å¯¼èˆª</h1>

    <!-- ä¸Šä¼  PDF -->
    <form action="/pdf/upload/" method="post" enctype="multipart/form-data">
        <input type="file" name="pdf" required>
        <button type="submit">ä¸Šä¼  PDF</button>
    </form>

    <h2>åˆ›å»ºä¹¦ç­¾</h2>
    <input type="number" id="page-number" placeholder="é¡µç " min="1">
    <input type="text" id="bookmark-desc" placeholder="æè¿°">
    <button onclick="createBookmark()">æ·»åŠ ä¹¦ç­¾</button>

    <h2>ä¹¦ç­¾å¯¼èˆª</h2>
    <ul id="bookmarks"></ul>

    <h2>PDF é¢„è§ˆ</h2>
    <img id="pdf-viewer" width="100%" height="600px">

    <h3>æˆªå±åŠŸèƒ½</h3>
    <button onclick="selectArea()">Select Area</button>
    <button onclick="PPImage()">Read Area</button>
{#    <div id="content-to-screenshot">#}
{#        <!-- è¿™é‡Œæ˜¯éœ€è¦æˆªå±çš„å†…å®¹ -->#}
{#        <p>This is some content that will be captured in the screenshot.</p>#}
{#    </div>#}

    <script>
        let bookmarks = {};  // å­˜å‚¨ä¹¦ç­¾ä¿¡æ¯ { é¡µç : {desc: "æè¿°", url: "å¯¹åº”å›¾ç‰‡è·¯å¾„"} }

        function createBookmark() {
            let pageNum = document.getElementById("page-number").value;
            let desc = document.getElementById("bookmark-desc").value.trim();

            if (!pageNum || !desc) {
                alert("è¯·å¡«å†™é¡µç å’Œæè¿°");
                return;
            }

            let imgUrl = `/media/pdf_images/page_${pageNum}.jpg`;

            if (!bookmarks[pageNum]) {
                bookmarks[pageNum] = { desc: desc, url: imgUrl };

                let li = document.createElement("li");
                li.textContent = `ğŸ“Œ ${desc} (ç¬¬ ${pageNum} é¡µ)`;
                li.setAttribute("data-url", imgUrl);

                // âœ… æ·»åŠ  `console.log()` æ–¹ä¾¿è°ƒè¯•
                li.ondblclick = function () {
                    let viewer = document.getElementById("pdf-viewer");
                    let url = this.getAttribute("data-url");
                    console.log("åŒå‡»ä¹¦ç­¾ï¼Œæ›´æ–°åˆ°: ", url);
                    viewer.src = url;
                };
                document.getElementById("bookmarks").appendChild(li);
            }
        }

        let isSelect = false;
        function selectArea(){
            if (isSelect){
                console.log("ç¦æ­¢è¿ç»­ç‚¹å‡»")
                return;
            }
            isSelect = true
            console.log("é¼ æ ‡æ¾å¼€ï¼Œå¼€å§‹æ‰§è¡ŒselectArea()")
            fetch('/pdf/select_area/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'  // æ·»åŠ  CSRF ä»¤ç‰Œ
                }
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            }).then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    console.log("Selected area: \nstart_x: ",data.start_x,"start_y: ",data.start_y,"end_y: ", data.end_x,"end_y: ",data.end_y)
                    console.log("",)
                    alert(`Selected area: (${data.start_x}, ${data.start_y}) to (${data.end_x}, ${data.end_y})`);
                }
            }).catch(error => {
                alert('Failed to select area: ' + error.message);
            });
        }

        function PPImage(){
            // è°ƒç”¨ capture_area è§†å›¾
            fetch('/pdf/preprocess_image/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'  // æ·»åŠ  CSRF ä»¤ç‰Œ
                }
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            }).then(data => {
                if (data.success) {
                    alert('Image to text conversion!');
                } else {
                    alert('Failed to Image to text conversion: ' + (data.error || 'Unknown error'));
                }
            }).catch(error => {
                alert('Failed to Image to text conversion: ' + error.message);
            });
        }
    </script>

</body>
</html>